<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/main2.css">
    <link rel="stylesheet" href="/main.css">
    <link rel="stylesheet" href="/common/footer.css">
    <link rel="stylesheet" href="/user/font.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js" charset="utf-8"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <link href="//db.onlinewebfonts.com/c/92b994e3bb31598967f16764d8f05352?family=FF+Signa+Serif+Stencil" rel="stylesheet" type="text/css"/>
    <link href="//db.onlinewebfonts.com/c/e0af8ee8cc49f194718d96d95440836f?family=Multicolore" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="http://localhost:3000/js/main.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://localhost:3000/js/scroll.js" charset="utf-8"></script>
    <script type="text/javascript">
    

        document.addEventListener('DOMContentLoaded',()=>{
            const webSocket = new WebSocket('ws://localhost:3000')

            const form = document.querySelector('form')

            webSocket.onopen = () => {
                console.log('ì›¹ì†Œì¼“ Connection ì„±ê³µ ( Handshake )')
            }

            form.addEventListener('submit', (e)=>{
                e.preventDefault()
                const{ input } = e.target

                let data = {
                        type:'send_msg',
                        userid:'{{userid}}',
                        data:input.value
                    }
                
                webSocket.send(JSON.stringify(data))
                input.value = ''
                // input.focus() << ì´ê±° ë­ì„?
            })

            webSocket.onmessage = (event) => {
                const chat = document.querySelector('#chat')
                const spanElement = document.createElement('span')
                const divElement = document.createElement('div')
                spanElement.innerHTML = event.data
                divElement.appendChild(spanElement)
                chat.appendChild(divElement)
                

                const author = spanElement.innerHTML.split(':')[0]
                if ( author == "{{userid}}") {
                divElement.setAttribute('class', 'me' )
                }
                else {
                    divElement.setAttribute('class', 'you')
                }
                
                chat.scrollTop = chat.scrollHeight
            }

            webSocket.onclose = () => {
                console.log('ì›¹ì†Œì¼“ disconnection')
            }
            const logout2 = document.querySelector('#logout')
            logout2.addEventListener('click', async (d)=>{
                d.preventDefault()

                const option = {
                    'Content-type':'application/json',
                    withCredentials:"true"
                }

                const response = await axios.post('http://localhost:4000/api/user/logout',null,option)
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤')
                location.href='http://localhost:3000'
            })
            
            //ì‹œê°„



            const clock = document.querySelector('.h1-clock');


            function getTime(){
                const time = new Date();
                const hour = time.getHours();
                const minutes = time.getMinutes();
                const seconds = time.getSeconds();
                //clock.innerHTML = hour +":" + minutes + ":"+seconds;
                clock.innerHTML = `${hour<10 ? `0${hour}`:hour}:${minutes<10 ? `0${minutes}`:minutes}:${seconds<10 ? `0${seconds}`:seconds}`
            }


            function init(){
                setInterval(getTime, 1000);
            }

            init();
        })
    </script>
    <script>

        //ë‹¬ë ¥
        $(document).ready(function() {
            calendarInit();
        });
    /*
        ë‹¬ë ¥ ë Œë”ë§ í•  ë•Œ í•„ìš”í•œ ì •ë³´ ëª©ë¡ 
    
        í˜„ì¬ ì›”(ì´ˆê¸°ê°’ : í˜„ì¬ ì‹œê°„)
        ê¸ˆì›” ë§ˆì§€ë§‰ì¼ ë‚ ì§œì™€ ìš”ì¼
        ì „ì›” ë§ˆì§€ë§‰ì¼ ë‚ ì§œì™€ ìš”ì¼
    */
    
        function calendarInit() {
    
            // ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            var date = new Date(); // í˜„ì¬ ë‚ ì§œ(ë¡œì»¬ ê¸°ì¤€) ê°€ì ¸ì˜¤ê¸°
            var utc = date.getTime() + (date.getTimezoneOffset() * 60 * 1000); // uct í‘œì¤€ì‹œ ë„ì¶œ
            var kstGap = 9 * 60 * 60 * 1000; // í•œêµ­ kst ê¸°ì¤€ì‹œê°„ ë”í•˜ê¸°
            var today = new Date(utc + kstGap); // í•œêµ­ ì‹œê°„ìœ¼ë¡œ date ê°ì²´ ë§Œë“¤ê¸°(ì˜¤ëŠ˜)
        
            var thisMonth = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            // ë‹¬ë ¥ì—ì„œ í‘œê¸°í•˜ëŠ” ë‚ ì§œ ê°ì²´
        
            
            var currentYear = thisMonth.getFullYear(); // ë‹¬ë ¥ì—ì„œ í‘œê¸°í•˜ëŠ” ì—°
            var currentMonth = thisMonth.getMonth(); // ë‹¬ë ¥ì—ì„œ í‘œê¸°í•˜ëŠ” ì›”
            var currentDate = thisMonth.getDate(); // ë‹¬ë ¥ì—ì„œ í‘œê¸°í•˜ëŠ” ì¼
    
            // kst ê¸°ì¤€ í˜„ì¬ì‹œê°„
            // console.log(thisMonth);
    
            // ìº˜ë¦°ë” ë Œë”ë§
            renderCalender(thisMonth);
    
            function renderCalender(thisMonth) {
    
                // ë Œë”ë§ì„ ìœ„í•œ ë°ì´í„° ì •ë¦¬
                currentYear = thisMonth.getFullYear();
                currentMonth = thisMonth.getMonth();
                currentDate = thisMonth.getDate();
    
                // ì´ì „ ë‹¬ì˜ ë§ˆì§€ë§‰ ë‚  ë‚ ì§œì™€ ìš”ì¼ êµ¬í•˜ê¸°
                var startDay = new Date(currentYear, currentMonth, 0);
                var prevDate = startDay.getDate();
                var prevDay = startDay.getDay();
    
                // ì´ë²ˆ ë‹¬ì˜ ë§ˆì§€ë§‰ë‚  ë‚ ì§œì™€ ìš”ì¼ êµ¬í•˜ê¸°
                var endDay = new Date(currentYear, currentMonth + 1, 0);
                var nextDate = endDay.getDate();
                var nextDay = endDay.getDay();
    
                // console.log(prevDate, prevDay, nextDate, nextDay);
    
                // í˜„ì¬ ì›” í‘œê¸°
                $('.year-month').text(currentYear + '.' + (currentMonth + 1));
    
                // ë Œë”ë§ html ìš”ì†Œ ìƒì„±
                calendar = document.querySelector('.dates')
                calendar.innerHTML = '';
                
                // ì§€ë‚œë‹¬
                for (var i = prevDate - prevDay + 1; i <= prevDate; i++) {
                    calendar.innerHTML = calendar.innerHTML + '<div class="day prev disable">' + i + '</div>'
                }
                // ì´ë²ˆë‹¬
                for (var i = 1; i <= nextDate; i++) {
                    calendar.innerHTML = calendar.innerHTML + '<div class="day current">' + i + '</div>'
                }
                // ë‹¤ìŒë‹¬
                for (var i = 1; i <= (7 - nextDay == 7 ? 0 : 7 - nextDay); i++) {
                    calendar.innerHTML = calendar.innerHTML + '<div class="day next disable">' + i + '</div>'
                }
    
                // ì˜¤ëŠ˜ ë‚ ì§œ í‘œê¸°
                if (today.getMonth() == currentMonth) {
                    todayDate = today.getDate();
                    var currentMonthDate = document.querySelectorAll('.dates .current');
                    currentMonthDate[todayDate -1].classList.add('today');
                }
            }
    
            // ì´ì „ë‹¬ë¡œ ì´ë™
            $('.go-prev').on('click', function() {
                thisMonth = new Date(currentYear, currentMonth - 1, 1);
                renderCalender(thisMonth);
            });
    
            // ë‹¤ìŒë‹¬ë¡œ ì´ë™
            $('.go-next').on('click', function() {
                thisMonth = new Date(currentYear, currentMonth + 1, 1);
                renderCalender(thisMonth); 
            });
        }
    </script>
</head>
<body>
<div id="wrap">
    <div id="Transparency" class="">

    </div>
    <header id="header">
        <div id="banner">
            <div id="logo_box">
                <a href="/"><img id="logo"src="http://localhost:3000/logo.png"></a>
            </div>

            <div id="access2">
                <ul>
                    <li>
                        <span class="menu_open">Board</span>
                        <ul id="bd_list" class="">
                            <li>
                                <a href="/board/cate1">ììœ ê²Œì‹œíŒ</a>
                            </li>
                            <li>
                                <a href="/board/QnA">Q & A</a>
                            </li>
                            <li>
                                <a href="/board/request">ì²­ì›ê²Œì‹œíŒ</a>
                            </li>
                            <li>
                                <a href="/board/question">ì½”ë“œìë¬¸</a>
                            </li>
                            <li>
                                <a href="/board/notice">ê³µì§€ì‚¬í•­</a>
                            </li>
                        </ul>
                     
                    </li>
                    <li>
                        <a href="/board/notice">Notice</a>
                    </li>
                    <li>
                        <a href="/user/profile?nickname={{nickname}}">Profile</a>
                    </li>
                    <li>
                        <a href="/user/logout" id="logout">Logout</a>
                    </li>

                </ul>
            </div>
        
            <div id="hamberger">
                <input type="checkbox" id="icon">
                <label for="icon">  <!--labelì€ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼-->
                    <span></span>
                    <span></span>
                    <span></span>
                </label>
                <div id="menu">
                    <ul>
                        <li><a href="http://localhost:3000/community/introduce">Introduce</a></li>
                        <li><a href="http://localhost:3000/matching/duo">Enjoy it!</a></li>
                        <li><a href="http://localhost:3000/board/notice">News</a></li>
                        <li><a href="http://localhost:3000/rank">This month</a></li>
                    </ul>
                </div>
            </div>
            </div>
            <div id="main_pic">
                <h3 id="main_txt">
                    <span class="msg">ONLY FOR</span>
                    <span class="msg">KYUNGIL STUDENTS</span>
                    <span class="line"></span>
                    <br>
                    <span class="msg">ENJOY IT !</span>
            
                <h3>
                <div id="slide_area">
                    <div id="pic_box">
                        <div>
                            <img src="http://localhost:3000/blockchain.jpeg">
                        </div>
                        <div>
                            <img src="http://localhost:3000/programming.jpg">
                        </div>
                        <div>
                            <img src="http://localhost:3000/planning.jpg">
                        </div>
                        <div>
                            <img src="http://localhost:3000/artworks.jpg">
                        </div>
                    </div>
                </div>
            </div>
            
    </header>


    <content id="main_content">
<!-- ì¹´ë“œ ë‰´ìŠ¤ íŒŒíŠ¸-->
        <div id="container1">
            <h1 class="card_title">Card News</h1>
            <div id='card_wrap'>

                <table id="board_table">
                    <tbody id="board_list">
                        
                    </tbody>
                </table>

                <template id="board_temp">
                    <div class="cards">
                    <span><a href="http://localhost:3000/board/cate1/view?idx={idx}">{img1}</a></span>
                        <br>
                        <span id="temp_title">
                            <a href="http://localhost:3000/board/cate1/view?idx={idx}">{title}</a>
                        </span>
                    </div>
                </template>

            </div>

        </div>
<!-- ì—¬ê¸°ê¹Œì§€ -->

        <div id="container2">
            <div id="hot_board">
                <h2>ì¸ê¸° ê²Œì‹œë¬¼ ğŸ”¥</h1>
                <ul class="many_likes">

                </ul>
            </div>
            <div id="event_board">
                <h2>ğŸ‰ ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸</h2>
                <ul class="event_list">
                    <li><a href="http://localhost:3000/board/cate1/view?idx=27">4ì›”ì˜ ì´ë²¤íŠ¸ ê³µì§€</a></li>
                    <li><a href="http://localhost:3000/board/cate1/view?idx=28">3ì›” ì´ë²¤íŠ¸ ë‹¹ì²¨ì ë°œí‘œ</a></li>
                    <li><a href="http://localhost:3000/board/cate1/view?idx=26">ì¹œêµ¬ì—ê²Œ í•™ì› ì¶”ì²œí•˜ê³  ì„ ë¬¼ë°›ì!</a></li>
                    <li><a href="http://localhost:3000/board/cate1/view?idx=25">ë§ˆìŒì„ ì „í•´ë³´ì„¸ìš”!</a></li>
                </ul>
            </div>
            <div id="this_month_student">
                <h2><a href="http://localhost:3000/rank"> ì´ë‹¬ì˜ í•™ìƒ ğŸ†</a></h2>
                <ul class="best_student">

                </ul>
            </div>
        </div>
        <div id="container3">
            <div id="live_chat">
                <img src="http://localhost:3000/live_chat.png">
            </div>
            <div id="chat_box">
                <div id="chat_wrap">
                    <div id="chat_space">
                        <ul id="chat">
                        
                        </ul>
                    </div>
                </div>

                <form id="frm_chat" action="/" method="get">
                    <input type="text" name="input" id="input">
                    <input type="submit" value="ì „ì†¡">
                </form>
            </div>
            <div id="deco">
                <div id="calender">
                    <div class="sec_cal">
                        <div class="cal_nav">
                          <a href="javascript:;" class="nav-btn go-prev">prev</a>
                          <div class="year-month"></div>
                          <a href="javascript:;" class="nav-btn go-next">next</a>
                        </div>
                        <div class="cal_wrap">
                          <div class="days">
                            <div class="day">MON</div>
                            <div class="day">TUE</div>
                            <div class="day">WED</div>
                            <div class="day">THU</div>
                            <div class="day">FRI</div>
                            <div class="day">SAT</div>
                            <div class="day">SUN</div>
                          </div>
                          <div class="dates"></div>
                        </div>
                      </div>
                </div>

                <div id="current_time">
                    <span class="time_text"> í˜„ì¬ ì‹œê°ì€ </span>
                    <h1 class = "h1-clock"></h1>
                </div>
            </div>
        </div>

        <template id="hot_temp">
            <li><a href="http://localhost:3000/board/cate1/view?idx={idx}">{title}</a></li>
        </template>

        <template id="hot_student_temp">
            <li>{nickname}({userid})</li>

        </template>

    

    </content>

    {% include "./utils/footer.html" %}

    <script type="text/javascript">
        let test = {}
        let hope = []
        const option = {
            'Content-type':'application/json',
            withCredentials:true
        }

    document.addEventListener('DOMContentLoaded', async() => {
        const data = { category: 'notice' }

        const response1 = await axios.post('http://localhost:4000/api/board/cate1/list', data, option)
        test = { ...response1.data }
        const cate1_list = response1.data

        let content_list2 = []
        for (let i =0; i<response1.data.result1.length; i++) {
            if(response1.data.result1[i].hidden =='off') {
                content_list2.push(response1.data.result1[i])
            }
        }

    // ì¸ë„¤ì¼

        const response2 = await axios.post('http://localhost:4000/api/cardimg', data, option) 

        const tempThumb = response2.data.final_result // [{}, {}, {}]
        let thumbNail = []

        for (let i = 0; i<tempThumb.length; i++) {
            if(tempThumb[i].img1 !== 'N/A') {
                thumbNail.push(tempThumb[i].img1)
            }
            else {
                thumbNail.push('default.jpg')
            }
        }


        for (let i = 0; i<6; i++) {
            let nProduct = { ...content_list2[i] }
            nProduct.img1 = thumbNail[i]
            hope.push(nProduct)
        }

        let template = ''
        search_list = []
        const board_temp = document.querySelector('#board_temp').innerHTML

        const promise = hope.forEach( (v)=>{
        search_list.push(v)
        let {idx, img1, category, title, nickname, userid, content, date, hit, likes, hidden} = v

        template +=
            board_temp.replace('{img1}',`<img src='http://localhost:4000/uploads/${img1}'>`)
            .replace('{title}',title)
            .replace('{idx}', idx)
        })

        board_list.innerHTML = template

        //ì¸ê¸°ê¸€

        const board_response = await axios.post('http://localhost:4000/api/hotboard', null, option)
        let board_template = ''
        const many_likes = document.querySelector('.many_likes') //ì¸ê¸°ê¸€ ë¦¬ìŠ¤íŠ¸ ë“¤ì–´ê°€ëŠ” ê³³
        const hot_temp = document.querySelector('#hot_temp').innerHTML //Hot í…œí”Œë¦¿ innerhtml

        console.log(board_response.data)

        const board_inner = board_response.data

        board_inner.forEach((v)=>{
            const {idx, title} = v
            board_template += hot_temp.replace('{idx}', idx)
                                        .replace('{title}', title)
        })

        many_likes.innerHTML = board_template

        //ì´ë‹¬ì˜ í•™ìš°

        //ì´ë¦„ ë³€ê²½
        var maskingName = function(strName) {
            if (strName.length > 2) {
                var originName = strName.split('');
                originName.forEach(function(name, i) {
                if (i === 0 || i === originName.length - 1) return;
                originName[i] = '*';
                });
                var joinName = originName.join();
                return joinName.replace(/,/g, '');
            } else {
                var pattern = /.$/; // ì •ê·œì‹
                return strName.replace(pattern, '*');
            }
        };


        const student_response = await axios.post('http://localhost:4000/api/hotstudent1', null, option)
        let student_template = ''
        const best_student = document.querySelector('.best_student') //ì´ë‹¬ì˜ í•™ìƒ ë¡œë“œ í•  ê³³
        const hot_student_temp = document.querySelector('#hot_student_temp').innerHTML //í…œí”Œë¦¿ innerhtml


        let student_arr = student_response.data //ëŒ“ê¸€ top 3 ë¦¬ìŠ¤íŠ¸
        const student_response2 = await axios.post('http://localhost:4000/api/hotstudent2', null, option)

        student_response.data.forEach((v)=>{
            const {nickname, userid} = v
            const change_userid = maskingName(`${userid}`.replaceAll(' ',''))

            student_template += hot_student_temp.replace('{userid}',change_userid)
                                    .replace('{nickname}', nickname)

        })
        student_response2.data.forEach((v)=>{
            const {nickname, userid} = v
            const change_userid = maskingName(`${userid}`.replaceAll(' ',''))

            student_template += hot_student_temp.replace('{userid}',change_userid)
                                    .replace('{nickname}', nickname)

        })

        best_student.innerHTML = student_template


        

    })

    </script>
</div>
<style>
    #container1 {
        position: relative;
    }

    #card_wrap {
        position: absolute;
        width: 100%;
        height: 100%;
    }

    #board_table {
        position:relative;
    }

    #board_list {
        display:flex;
        justify-content: space-evenly;
        flex-wrap: wrap;
        position:relative;
        width: 800px !important;
        
    }

    .cards {
        width: 300px;
        padding: 25px 30px 25px 30px;
    }

    .cards > span:nth-child(2) {
        text-align: center;
        color: black !important;

    }

    .cards > span > a > img {
        width: 300px !important;
        height:200px;
        border-radius: 10px;
    }

    #temp_title {
        font-size: 24px;
        text-align: center;

    }

    #temp_title > a {
        color: black;
        text-align: center;
        display: block;
        width: 100%;
    }
</style>
</body>
</html>