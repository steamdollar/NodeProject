{% extends 'utils/header.html' %}

{% block content %}
<body>
    <div id="useruser">
        <span id="userid">{{userid}}</span>
        <span id="mynick" style ='display: none;'>{{nickname}}</span>
    </div>
    <div id="view_wide">
        <div id="view_wrap">
            <dl>
                <dt id="view_dt">
                    <div id="view_title">
                        <span id="title">{{cate1_view.title}}</span>
                    </div>
                    <div id="view_head">
                        <span id="category">{{cate1_view.category}}</span>
                        <span id="view_date">{{ cate1_view.date }}</span>
                        <span id="writerid">{{cate1_view.userid}}</span>
                        <span id="nickname"><a id='userinfo' href="/user/profile?nickname={{cate1_view.nickname}}">{{ cate1_view.nickname }}</a></span>
                    </div>
                </dt>
                <dd id="view_dd">
                    <div id="view_content">
                        <div id="view_userimg">
                            <span id="userimg"></span>
                        </div>
                        {{ cate1_view.content }}
                    </div>
                    <div id="view_good">
                        <form method="post" action="http://localhost:4000/api/board/cate1/like" id="like">
                            <input type="submit" value="ğŸ’—" id="thumb">
                        </form>
                    </div>
                    <div id="view_like">
                        <span id="likecount"></span>
                    </div> 
                </dd>
                <div id="view_form">
                    <div id="view_modify">
                        <a href='/board/cate1/update?idx={{cate1_view.idx}}' id="form_lk">ìˆ˜ì •</a>
                    </div>
                    <form method="post" action="http://localhost:4000/api/board/cate1/delete" id="del_frm">
                        <input type="hidden" name='idx' value="{{cate1_view.idx}}" id="idx"> 
                        <input type="submit" value="ê¸€ ì‚­ì œ" id="view_form_sub">
                    </form>
                </div>
                <div id="view_hash">
                    Hashtag : 
                    {% for item in cate1_hashtag %}
                    <span>#{{item.hashtag_name}}</span>
                    {% endfor %}
                </div>  
            </dl>
        </div>
        <!-- <div>
            <ul id="commentApp">
            </ul>
        </div> -->
        <!-- ëŒ“ê¸€ì‹œìŠ¤í…œ ë Œë”ë§í•˜ëŠ” div-->
        <div id="view_cmt">
            <div id="view_app">
                <ul id="commentApp">
                </ul>
            </div>
            <template id="commentForm">
                <li class="comment-form">
                    <form method="post" action="" class="cmt_frm">
                        <h4>ëŒ“ê¸€ <span>()</span> </h4>
                        <span class="ps_box">
                            <input type="text" placeholder="ì—¬ëŸ¬ë¶„ì˜ ì†Œì¤‘í•œ ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." class="int" value="" name="input">
                        </span>
                        <input type="submit" class="btn" value="ëŒ“ê¸€ë‹¬ê¸°" />
                    </form>
                </li>
            </template>
            <!-- ëŒ“ê¸€ ì‘ì„± -->
            <template id="commentList">
                <li class="c_list">
                    <ul class="comment-row">
                        <li class="comment-id"></li>
                        <li class="comment-content">    
                            <input type="hidden" name="idx" value=""/>
                            <span class="comment-delete-btn">X</span>
                        </li>
                        <li class="comment-date"></li>
                    </ul>
                </li>
            </template>
            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <template id="commentInput">
                <span>
                    <input type="text" class="comment-update-input" value="">
                </span>
            </template>
        </div>
        <div id="view_list">
            <a href="/board/cate1" class="v_list">ê¸€ ëª©ë¡</a>
        </div>
    </div>
    
    <script type="text/javascript">
        const option = {
            'Content-type':'application/json',
            withCredentials:true
        }
        const idx = document.querySelector('#idx')
        const category = document.querySelector('#category')
        const userid = document.querySelector('#userid')

        document.addEventListener('DOMContentLoaded', async() => {
            const likeCount = document.querySelector('#likecount')
            const idx = document.querySelector('#idx')

            const data = {
                idx:idx.value
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/likeCount', data, option)
            let [likeNum] = Object.values(response.data.result[0])
            likeCount.innerHTML =likeNum

            const response2 = await axios.post('http://localhost:4000/api/board/cate1/viewuser', null, option)
            const Usernick = response2.data.result[0].nickname
            let nickname = "{{cate1_view.nickname}}"

            if(nickname !== Usernick){
              
            } else{

            }
            
        })

        // ì¢‹ì•„ìš” ëˆ„ë¥´ê¸°(done)
        const like = document.querySelector('#like')

        like.addEventListener('submit', async (e) => {
            e.preventDefault()

            const idx = document.querySelector('#idx')
            const userid = document.querySelector('#userid')

            const data = {
                userid:userid.innerHTML,
                idx: idx.value
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/like', data ,option)
            const likeCount = document.querySelector('#likecount')
            if (response.data.errno === 1) {
                alert('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤')
                likeCount.innerHTML--
            }
            else {
                alert('ì´ ê²Œì‹œë¬¼ì„ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.')
                likeCount.innerHTML++
            }
        })

        
        // ê¸€ ì‚­ì œ

        const delForm = document.querySelector('#del_frm')      
        delForm.addEventListener('submit', async (e) => {
            e.preventDefault()

            const idx = delForm.querySelector('#idx')
            const writerid = document.querySelector('#writerid')
            const userid = document.querySelector('#userid')

            const data = {
                idx:idx.value,
                category:category.innerHTML,
                writerid:writerid.innerHTML,
                userid:userid.innerHTML
            }

            const response = await axios.post('http://localhost:4000/api/board/cate1/delete', data, option)

            if(response.data.errno === 0 ) {
                alert('ê¸€ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')
                location.href='/board/cate1'
            }
            else {
                alert('ìˆ˜í–‰í•  ìˆ˜ ì—†ëŠ” ëª…ë ¹ì…ë‹ˆë‹¤.')
            }
        })

        //
        //

        let state = {}
        state.comment=[]
        state.length=''

        document.addEventListener('DOMContentLoaded', async () => {
            const imgZone = document.querySelector('#userimg')
            const icategory = "{{cate1_image.category}}"
            const midx = "{{cate1_image.midx}}"
            const img1 = "{{cate1_image.img1}}"
            const img2 = "{{cate1_image.img2}}"
            const img3 = "{{cate1_image.img3}}"
            const img4 = "{{cate1_image.img4}}"
            const img5 = "{{cate1_image.img5}}"

            const tempImgArr = [img1, img2, img3, img4, img5]

            const imgArr = []

            for (let i =0; i<tempImgArr.length; i++) {
                if(tempImgArr[i] !== 'N/A') {
                    imgArr.push(tempImgArr[i])
                }
            }

            for ( let i =0; i<imgArr.length; i++) {
                const imgSpan = document.createElement('span')
                const imgElement = document.createElement('img')
                imgElement.setAttribute('src', `http://localhost:4000/uploads/${imgArr[i]}`)
                imgSpan.append(imgElement)
                imgZone.append(imgSpan)
            } 
        })
        //
        //
        document.addEventListener('DOMContentLoaded', async () => {
            const uri = location.pathname
            const cate = document.querySelector('#category').innerHTML
            const data = {
                idx:idx.value,
                cate:cate,
            }

            const replyResponse = await axios.post('http://localhost:4000/api/board/comment/view', data, option)

            let comment = replyResponse.data.result1 // array
            let length = replyResponse.data.result1.length
            
            state = {
                ...state,
                comment:comment,
                length:length
            }

            const commentApp = document.querySelector('#commentApp')
            const commentForm = document.querySelector('#commentForm')
            const commentList = document.querySelector('#commentList')
            const commentInput = document.querySelector('#commentInput')

            // ê°€ì¥ ì•„ë˜ commentView() í•¨ìˆ˜ê°€ ìˆë‹¤. ê·¸ê²Œ ìš°ì„  ì‹¤í–‰ëœë‹¤. = ì›ë˜ ìˆëŠ” ëŒ“ê¸€ë“¤ì„ ë³´ì—¬ì¤€ë‹¤.
            // ê·¼ë° ê·¸ ì•ˆì— createForm() ì´ ìˆê³ , ê·¸ ì•ˆì— submitHandlerê°€ ìˆë‹¤.
            // ë…¼ë¦¬ êµ¬ì¡° í•œ ë²ˆ ì‹œë°œ ë³µì¡í•˜ë„¤..
        
            function commentView() {
                commentApp.innerHTML = '' // ëŒ“ê¸€ zone ì´ˆê¸°í™”
                createForm()

                state.comment.forEach(v => { // ê°ê°ì˜ ëŒ“ê¸€ì— ëŒ€í•´ ì‹¤í–‰
                    const clone = document.importNode(commentList.content, true)
                    // CommentList í…œí”Œë¦¿ì˜ ë‚´ìš©ë¬¼ì„ ê°€ì ¸ì˜¨ë‹¤
                    const row = clone.querySelectorAll('.comment-row > li')
                    // ê·¸ ì•ˆì—ì„œ li elementë“¤ì„ ì£„ë‹¤ ì„ íƒ
                    row[0].innerHTML = v.userid
                    // ì²« ë²ˆì§¸ listëŠ” userid ì…ë ¥
                    row[1].querySelector('input').value = v.idx
                    // ë‘ ë²ˆì§¸ liëŠ” idx ì…ë ¥
                    
                    if ( v.updateFlag == 'true') {
                        const spanElement = document.createElement('span')
                        spanElement.innerHTML = v.content
                        // span elementë¥¼ ë§Œë“¤ì–´ ëŒ“ê¸€ ë‚´ìš©ì„ ë„£ëŠ”ë‹¤.
                        const deleteBtn = row[1].querySelector('.comment-delete-btn')
                        // 'X' ê°€ ìˆëŠ” span ì„ íƒ 
                        spanElement.addEventListener('click',updateHandler)
                        // ëŒ“ê¸€ì„ í´ë¦­í•˜ë©´ ìˆ˜ì • í•¨ìˆ˜ ì‹¤í–‰ ë˜ê²Œ addEventListener
                        deleteBtn.addEventListener('click',deleteHandler)
                        // 'X' í´ë¦­ì‹œ ì‚­ì œ í•¨ìˆ˜ ì‹¤í–‰
                        row[1].prepend(spanElement)
                        // prependëŠ” appendì™€ ë™ì¼í•˜ì§€ë§Œ ê°€ì¥ ì•ì— ìš”ì†Œê°€ ì¶”ê°€ë¨
                    } 
                    else {
                        const clone = document.importNode(commentInput.content,true)
                        clone.querySelector('input').value = v.content
                        clone.querySelector('input').addEventListener('keypress',updateSubmitHandler)
                        row[1].prepend(clone)
                    }

                    row[2].innerHTML = v.date

                    commentApp.appendChild(clone)
                })
            }

            function createForm(){
                const clone = document.importNode(commentForm.content, true) // commentForm ì•ˆì— ìˆëŠ” ìš”ì†Œë“¤ì„ ê·¸ëƒ¥ ê°€ì ¸ì˜¨ê±°ì„.
                const form = clone.querySelector('form') // ê·¸ì¤‘ formì„ ì„ íƒ
                const counting = form.querySelector('h4 > span') // ë¹ˆ ê´„í˜¸ ë§í•˜ëŠ”ê±°
                counting.innerHTML = `(${state.comment.length})` // ê·¸ ë¹ˆ ê´„í˜¸ì— ëŒ“ê¸€ ê°¯ìˆ˜ë¥¼ ë„£ëŠ”ë‹¤.

                form.addEventListener('submit',submitHandler)
                commentApp.append(clone) // ëŒ“ê¸€ areaì— cloneì„ í†µí•©
            }
            // ëŒ“ê¸€ ì“°ëŠ” ëª¨ë“ˆ

            async function submitHandler (e){
                e.preventDefault()
                const { input } = e.target // ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” í•˜ëŠ” ê·¸ input

                const counting = e.target.querySelector('h4 > span')
                // ë¹ˆ ê´„í˜¸ > createFormì´ ì‹¤í–‰ëœ í›„ì—” ëŒ“ê¸€ì˜ ê°¯ìˆ˜ê°€ ì±„ì›Œì§
                const length = state.length
                const cidx = length != 0 ? parseInt(state.length + 1 ) : 1 
                // lengthê°€ 0 ì´ ì•„ë‹ˆë©´ ë‘ ë²ˆì§¸ í•­, 0ì´ë©´ ì„¸ë²ˆì§¸ í•­ì„ valueë¡œ ê°€ì§
                // idxëŠ” ëŒ“ê¸€ì´ í˜„ì¬ ê¸€ì˜ ëª‡ ë²ˆì§¸ ëŒ“ê¸€ì¸ì§€ë¥¼ ì•Œë ¤ì¤€ë‹¤. 
                // ê·¸ë˜ì„œ ì§€ê¸ˆê¹Œì§€ ë‹¨ ëŒ“ê¸€ ìˆ˜ë¥¼ ë¨¼ì € ê³„ì‚°í•˜ëŠ”ê²Œ 2ë²ˆì§¸ í•­ì´ê³ , 
                // ì—†ìœ¼ë©´ ì„¸ë²ˆì§¸í•­ì˜ valueì¸ 1ì„ ê°€ì§€ëŠ”ê²ƒ.

                //ë‚ ì§œ
                let today = new Date()
                let year = today.getFullYear()
                let month = ('0' + (today.getMonth() + 1)).slice(-2)
                let day = ('0' + today.getDate()).slice(-2)

                let dateString = year + '-' + month + '-' + day

                //ì‹œê°„
                let today2 = new Date()
                let hours = ('0' + today2.getHours()).slice(-2)
                let minutes = ('0' + today2.getMinutes()).slice(-2)
                let seconds = ('0' + today2.getSeconds()).slice(-2)

                let timeString = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds
               
    
                const result = {idx,userid:'{{userid}}', content:input.value, date:timeString, updateFlag:'true'}
                // ëŒ€ì¶© ì € state.replay ì²˜ëŸ¼ í¬ë§· ë§Œë“¤ì–´ì¤€ë‹¤.
                state = {
                    ...state,
                    comment:[
                        ...state.comment,
                        result
                    ],
                    length:replyResponse.data.result1.length + 1
                }
                // state ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸ í•´ì¤€ë‹¤. ë°©ê¸ˆ ì“´ ëŒ“ê¸€ì„ ì¶”ê°€í•˜ê³ , length ê°’ì„ 1 ë”í•œë‹¤.

                const mynick = document.querySelector('#mynick')
                const content = input.value
                const userid = document.querySelector('#userid')
                
                const data = {
                    cate: cate,
                    idx: idx.value,
                    content: content,
                    nickname:mynick.innerHTML,
                    userid:userid.innerHTML
                }
                
                const replyAdd = await axios.post('http://localhost:4000/api/board/comment/add', data, option)
                console.log(replyAdd.data.insertId)
                 

                // row[1].querySelector('input').value = replyAdd.data.insertId.value // !!!!!!!!!!!!!!!!!!!!!!!!
                input.value = '' // ëŒ“ê¸€ ë“±ë¡í•˜ë©´ formì€ ë‹¤ì‹œ ë¹ˆ ì¹¸ì´ ëœë‹¤.
                counting.innerHTML = `(${state.length})` // í™”ë©´ì— ë Œë”ë§ë˜ëŠ” ëŒ“ê¸€ ìˆ˜ë„ ì—…ë°ì´íŠ¸ í•´ì¤€ë‹¤.
                
                commentView()

                const comments = commentApp.querySelectorAll('li')
                const newComment = comments[comments.length-2]
                console.log(newComment)
                const newCommentInput = newComment.querySelector('input')
                newCommentInput.value = replyAdd.data.insertId
                console.log(state)
            }

            //

            function updateHandler(e){
                const idx = parseInt( e.target.parentNode.querySelector('input').value )
                const newReply = [...state.comment]
                let index 

                for (let i =0; i < newReply.length; i++){
                    if (newReply[i].idx === idx){
                        index = i
                    }
                }

                newReply[index].updateFlag = 'false'
                console.log(idx,newReply)
                state = {
                    ...state,
                    replay:newReply
                }

                commentView()
            }

            async function updateSubmitHandler(e){
                
                if(e.keyCode === 13) {
                    
                    const idx = parseInt( e.target.parentNode.parentNode.querySelector('input[type=hidden]').value )
                    console.log(e.target.parentNode.querySelector('input').value)
                    // ëŒ“ê¸€ í…Œì´ë¸”ì˜ pkì¸ idx ì˜ë¯¸
                    const content = e.target.parentNode.querySelector('input').value
                    const data = { 
                        idx:idx,
                        content: content
                    }
                    const updateReply = await axios.post('http://localhost:4000/api/board/comment/update', data, option)

                    const newReplay = [...state.replay]
                    let index 
                    for(let i =0; i < newReplay.length; i++){
                        if(newReplay[i].idx === idx){
                            index = i
                        }
                    }

                    newReplay[index].updateFlag = 'true'
                    newReplay[index].content = e.target.value

                    state = {
                        ...state,
                        comment:newReplay
                    }

                    commentView()
                }
            }

            async function deleteHandler(e){
                const idx = parseInt( e.target.parentNode.querySelector('input').value )
                
                const data = {
                    idx:idx                    
                }
                
                const commentDel = await axios.post('http://localhost:4000/api/board/comment/delete', data ,option)

                const newReply = state.comment.filter(v => v.idx !== idx)
                state = {
                    ...state,
                    comment:newReply,
                    length:newReply.length
                }
                commentView()
            }

            commentView()

            
        })
    </script>
    <style>
        #footer_wrap {
        bottom: -450px !important;
        position: relative;
    
    }
    </style>
{% endblock %}